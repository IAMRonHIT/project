<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMed Content Viewer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            background-color: #1a237e;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #content-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: #666;
        }
        .error {
            color: #e53935;
            padding: 20px;
            border: 1px solid #ffcdd2;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h2 id="title">PubMed Article Viewer</h2>
        <div>
            <small>Highlighting Enabled</small>
        </div>
    </div>
    <div id="content-container">
        <div class="loading">Loading PubMed content...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Extract PMCID from the URL query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const pmcid = urlParams.get('pmcid');
            
            if (!pmcid) {
                showError('No PMC ID provided. Please specify a pmcid in the URL.');
                return;
            }

            // Update the title
            document.getElementById('title').innerText = `PubMed Article (PMC${pmcid})`;
            
            // Fetch the PubMed content
            fetchPubMedContent(pmcid);
        });

        function fetchPubMedContent(pmcid) {
            const contentContainer = document.getElementById('content-container');
            const pubmedUrl = `https://www.ncbi.nlm.nih.gov/pmc/articles/${pmcid}/`;
            
            fetch(pubmedUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch PubMed content: ${response.status} ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(html => {
                    // Extract the main article content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Find the main content div - PubMed usually has an element with ID 'maincontent'
                    const mainContent = doc.getElementById('maincontent') || 
                                       doc.querySelector('.content-block') ||
                                       doc.querySelector('article');
                    
                    if (!mainContent) {
                        throw new Error('Could not locate main content in the PubMed article.');
                    }
                    
                    // Clean up the content a bit
                    // Remove any scripts
                    const scripts = mainContent.querySelectorAll('script');
                    scripts.forEach(script => script.remove());

                    // Add data-source attribute to help with highlighting
                    mainContent.setAttribute('data-source', `PubMed PMC${pmcid}`);
                    
                    // Replace content container with the extracted content
                    contentContainer.innerHTML = '';
                    contentContainer.appendChild(mainContent);
                    
                    // Fix relative URLs in the content
                    fixRelativeUrls(contentContainer, pubmedUrl);
                })
                .catch(error => {
                    showError(`Error: ${error.message}`);
                    console.error('Error fetching PubMed content:', error);
                });
        }

        function fixRelativeUrls(container, baseUrl) {
            // Fix relative URLs in images, links, etc.
            const images = container.querySelectorAll('img');
            images.forEach(img => {
                if (img.src && !img.src.startsWith('http')) {
                    img.src = new URL(img.getAttribute('src'), baseUrl).href;
                }
            });

            const links = container.querySelectorAll('a');
            links.forEach(link => {
                if (link.href && !link.href.startsWith('http')) {
                    link.href = new URL(link.getAttribute('href'), baseUrl).href;
                }
            });
        }

        function showError(message) {
            const contentContainer = document.getElementById('content-container');
            contentContainer.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>
